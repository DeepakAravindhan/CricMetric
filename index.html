<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cric Clarity Scorecard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            background-image: radial-gradient(circle at top right, #4338ca30, transparent 40%), radial-gradient(circle at bottom left, #be185d30, transparent 40%);
            color: #e2e8f0; /* Slate 200 */
        }

        .glass-panel {
            background-color: rgba(30, 41, 59, 0.6); /* Slate 800 with 60% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate 700 with 50% opacity */
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .ball-tag {
            width: 2.75rem;
            height: 2.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .ball-run { background-color: #374151; color: #f9fafb; border-color: #4b5563; }
        .ball-four { background-color: #2563eb; color: #ffffff; box-shadow: 0 0 12px #2563eb; border-color: #3b82f6; }
        .ball-six { background-color: #9333ea; color: #ffffff; box-shadow: 0 0 12px #9333ea; border-color: #a855f7; }
        .ball-wicket { background-color: #dc2626; color: #ffffff; box-shadow: 0 0 12px #dc2626; border-color: #ef4444; transform: scale(1.1); }
        .ball-extra { background-color: #ca8a04; color: #ffffff; box-shadow: 0 0 10px #ca8a04; border-color: #eab308; }

        .setup-input {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            color: #cbd5e1; /* Slate 300 */
            font-size: 0.9rem;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .setup-input:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 3px #4f46e550;
        }

        .gradient-text {
            background-image: linear-gradient(to right, #a5b4fc, #f9a8d4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .table-header-cell {
           padding: 0.75rem 1rem;
           text-align: center;
           font-weight: 600;
           letter-spacing: 0.05em;
           text-transform: uppercase;
           font-size: 0.75rem;
           color: #94a3b8; /* Slate 400 */
        }
        .table-body-cell {
            padding: 1rem;
            text-align: center;
            color: #e2e8f0; /* Slate 200 */
            font-weight: 500;
        }
        .table-body-row {
            border-bottom: 1px solid #334155; /* Slate 700 */
            transition: background-color 0.2s ease;
        }
         .table-body-row:last-child {
            border-bottom: none;
        }
        .striker-row { background-color: #4f46e530; }
        .bowler-row { background-color: #10b98130; }
    </style>
</head>

<body class="text-slate-200">

    <div id="app-container" class="p-4 md:p-6 lg:p-8 max-w-7xl mx-auto">

        <div id="setup-screen">
            <div class="glass-panel p-6 md:p-8">
                <div class="text-center">
                    <h1 class="text-4xl font-extrabold gradient-text mb-2">Cricket Scorecard Setup</h1>
                    <p class="text-slate-400 mb-8">Enter match details to begin your awesome scoring experience.</p>
                </div>
                
                <div class="mb-8">
                    <label for="total-overs-input" class="block text-lg font-semibold text-slate-300 mb-3 text-center">Total Overs per Innings</label>
                    <input type="number" id="total-overs-input" class="setup-input max-w-xs mx-auto text-center text-lg font-bold" value="5" min="1">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-indigo-400">Team A</h2>
                        <input type="text" id="team-a-name" placeholder="Enter Team A Name" class="setup-input mb-4 font-semibold" value="Lions XI">
                        <div id="team-a-players" class="space-y-3"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-pink-400">Team B</h2>
                        <input type="text" id="team-b-name" placeholder="Enter Team B Name" class="setup-input mb-4 font-semibold" value="Tigers XI">
                        <div id="team-b-players" class="space-y-3"></div>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <button id="start-match-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-4 px-10 rounded-lg hover:from-indigo-600 hover:to-purple-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-400/50 shadow-lg shadow-indigo-500/50">
                        Start Match
                    </button>
                </div>
            </div>
        </div>

        <div id="scorecard-screen" class="hidden">
            <header class="glass-panel p-4 md:p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h1 id="match-title" class="text-xl lg:text-2xl font-bold text-slate-100 text-center md:text-left"></h1>
                    <div class="flex space-x-2">
                        <button id="full-scorecard-btn" class="bg-blue-600/80 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600/100 transition">Full Scorecard</button>
                        <button id="undo-btn" class="bg-yellow-500/80 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-500/100 transition">Undo</button>
                        <button id="new-match-btn" class="bg-red-600/80 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600/100 transition">New Match</button>
                    </div>
                </div>
                <div id="main-score-display" class="text-center mt-4">
                    <p class="text-6xl md:text-7xl font-extrabold text-white tracking-tighter" id="score-display"></p>
                    <p class="text-lg text-slate-300 mt-1" id="overs-display"></p>
                    <p class="text-lg text-pink-400 font-bold mt-2" id="target-display"></p>
                    <div class="flex justify-center space-x-6 mt-2 text-sm font-medium text-slate-400">
                        <p id="crr-display"></p>
                        <p id="rrr-display"></p>
                    </div>
                    <p id="match-result-display" class="text-2xl font-bold text-green-400 mt-4 animate-pulse"></p>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel p-4 sm:p-6">
                        <h2 class="text-xl font-bold mb-4 text-slate-100">Batting</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead>
                                    <tr>
                                        <th scope="col" class="table-header-cell !text-left">Batsman</th>
                                        <th scope="col" class="table-header-cell">R</th>
                                        <th scope="col" class="table-header-cell">B</th>
                                        <th scope="col" class="table-header-cell">4s</th>
                                        <th scope="col" class="table-header-cell">6s</th>
                                        <th scope="col" class="table-header-cell">SR</th>
                                    </tr>
                                </thead>
                                <tbody id="batting-table"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="scoring-controls" class="glass-panel p-4 sm:p-6">
                        <h2 class="text-xl font-bold mb-4 text-slate-100">Live Scoring</h2>
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-3 mb-4">
                            <button data-run="0" class="run-btn bg-slate-600 hover:bg-slate-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">0</button>
                            <button data-run="1" class="run-btn bg-slate-600 hover:bg-slate-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">1</button>
                            <button data-run="2" class="run-btn bg-slate-600 hover:bg-slate-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">2</button>
                            <button data-run="3" class="run-btn bg-slate-600 hover:bg-slate-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">3</button>
                            <button data-run="4" class="run-btn bg-blue-600 text-white hover:bg-blue-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105 shadow-md shadow-blue-600/50">4</button>
                            <button data-run="6" class="run-btn bg-purple-600 text-white hover:bg-purple-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105 shadow-md shadow-purple-600/50">6</button>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                             <button id="wide-btn" class="extra-btn bg-yellow-500 text-black hover:bg-yellow-400 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">Wide</button>
                             <button id="noball-btn" class="extra-btn bg-yellow-500 text-black hover:bg-yellow-400 font-bold py-3 rounded-lg transition-transform transform hover:scale-105">No Ball</button>
                             <button id="wicket-btn" class="bg-red-600 text-white hover:bg-red-500 font-bold py-3 rounded-lg transition-transform transform hover:scale-105 shadow-md shadow-red-600/50">Wicket</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="glass-panel p-4 sm:p-6">
                        <h2 class="text-xl font-bold mb-4 text-slate-100">Bowling</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead>
                                    <tr>
                                        <th scope="col" class="table-header-cell !text-left">Bowler</th>
                                        <th scope="col" class="table-header-cell">O</th>
                                        <th scope="col" class="table-header-cell">M</th>
                                        <th scope="col" class="table-header-cell">R</th>
                                        <th scope="col" class="table-header-cell">W</th>
                                        <th scope="col" class="table-header-cell">Econ</th>
                                    </tr>
                                </thead>
                                <tbody id="bowling-table"></tbody>
                            </table>
                        </div>
                    </div>
                     <div class="glass-panel p-4 sm:p-6">
                        <h2 class="text-xl font-bold mb-4 text-slate-100">Overs Summary</h2>
                        <div id="overs-summary-display" class="space-y-3"></div>
                    </div>
                    <div class="glass-panel p-4 sm:p-6">
                        <h2 class="text-xl font-bold mb-4 text-slate-100">Fall of Wickets</h2>
                        <div id="fow-display" class="space-y-2 text-sm font-medium text-slate-300"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-75 hidden z-40"></div>
    
    <div id="player-selection-modal" class="fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="glass-panel p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 gradient-text">Select Players</h2>
            <div class="space-y-4">
                <div>
                    <label for="on-strike-select" class="block text-sm font-medium text-slate-300">On Strike Batsman:</label>
                    <select id="on-strike-select" class="setup-input mt-1"></select>
                </div>
                <div>
                    <label for="non-striker-select" class="block text-sm font-medium text-slate-300">Non-Striker:</label>
                    <select id="non-striker-select" class="setup-input mt-1"></select>
                </div>
                <div>
                    <label for="bowler-select" class="block text-sm font-medium text-slate-300">Current Bowler:</label>
                    <select id="bowler-select" class="setup-input mt-1"></select>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button id="confirm-players-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="wicket-modal" class="fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="glass-panel p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-red-400">Wicket Details</h2>
            <div class="space-y-4">
                <div>
                    <label for="player-out-select" class="block text-sm font-medium text-slate-300">Player Out:</label>
                    <select id="player-out-select" class="setup-input mt-1"></select>
                </div>
                <div>
                    <label for="dismissal-type-select" class="block text-sm font-medium text-slate-300">Dismissal Type:</label>
                    <select id="dismissal-type-select" class="setup-input mt-1">
                        <option>Bowled</option>
                        <option>Caught</option>
                        <option>LBW</option>
                        <option>Run Out</option>
                        <option>Stumped</option>
                        <option>Hit Wicket</option>
                    </select>
                </div>
                <div id="run-out-runs-container" class="hidden">
                    <label for="run-out-runs-input" class="block text-sm font-medium text-slate-300">Completed Runs:</label>
                    <input type="number" id="run-out-runs-input" class="setup-input mt-1" value="0" min="0" max="6">
                </div>
                <div id="fielder-container" class="hidden">
                    <label id="fielder-label" for="fielder-select" class="block text-sm font-medium text-slate-300">Fielder:</label>
                    <select id="fielder-select" class="setup-input mt-1"></select>
                </div>
                <div id="new-batsman-container">
                    <label for="new-batsman-select" class="block text-sm font-medium text-slate-300">New Batsman:</label>
                    <select id="new-batsman-select" class="setup-input mt-1"></select>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button id="confirm-wicket-btn" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-700 transition">Confirm Wicket</button>
            </div>
        </div>
    </div>

    <div id="full-scorecard-modal" class="fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="glass-panel w-full max-w-4xl max-h-[90vh] overflow-y-auto">
             <div class="sticky top-0 z-10 p-6 glass-panel !rounded-b-none">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold gradient-text">Full Match Scorecard</h2>
                    <button id="close-full-scorecard-btn" class="text-slate-400 hover:text-white text-3xl font-bold">&times;</button>
                </div>
            </div>
            <div id="full-scorecard-content" class="space-y-8 p-6"></div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            state: null,
            history: [],

            elements: {
                setupScreen: document.getElementById('setup-screen'),
                scorecardScreen: document.getElementById('scorecard-screen'),
                totalOversInput: document.getElementById('total-overs-input'),
                teamAName: document.getElementById('team-a-name'),
                teamBName: document.getElementById('team-b-name'),
                teamAPlayers: document.getElementById('team-a-players'),
                teamBPlayers: document.getElementById('team-b-players'),
                startMatchBtn: document.getElementById('start-match-btn'),
                matchTitle: document.getElementById('match-title'),
                scoreDisplay: document.getElementById('score-display'),
                oversDisplay: document.getElementById('overs-display'),
                targetDisplay: document.getElementById('target-display'),
                crrDisplay: document.getElementById('crr-display'),
                rrrDisplay: document.getElementById('rrr-display'),
                matchResultDisplay: document.getElementById('match-result-display'),
                battingTable: document.getElementById('batting-table'),
                bowlingTable: document.getElementById('bowling-table'),
                fowDisplay: document.getElementById('fow-display'),
                oversSummaryDisplay: document.getElementById('overs-summary-display'),
                scoringControls: document.getElementById('scoring-controls'),
                runBtns: document.querySelectorAll('.run-btn'),
                wideBtn: document.getElementById('wide-btn'),
                noballBtn: document.getElementById('noball-btn'),
                wicketBtn: document.getElementById('wicket-btn'),
                undoBtn: document.getElementById('undo-btn'),
                newMatchBtn: document.getElementById('new-match-btn'),
                fullScorecardBtn: document.getElementById('full-scorecard-btn'),
                modalBackdrop: document.getElementById('modal-backdrop'),
                playerSelectionModal: document.getElementById('player-selection-modal'),
                modalTitle: document.getElementById('modal-title'),
                onStrikeSelect: document.getElementById('on-strike-select'),
                nonStrikerSelect: document.getElementById('non-striker-select'),
                bowlerSelect: document.getElementById('bowler-select'),
                confirmPlayersBtn: document.getElementById('confirm-players-btn'),
                wicketModal: document.getElementById('wicket-modal'),
                playerOutSelect: document.getElementById('player-out-select'),
                dismissalTypeSelect: document.getElementById('dismissal-type-select'),
                fielderContainer: document.getElementById('fielder-container'),
                fielderLabel: document.getElementById('fielder-label'),
                fielderSelect: document.getElementById('fielder-select'),
                newBatsmanContainer: document.getElementById('new-batsman-container'),
                newBatsmanSelect: document.getElementById('new-batsman-select'),
                confirmWicketBtn: document.getElementById('confirm-wicket-btn'),
                runOutRunsContainer: document.getElementById('run-out-runs-container'),
                runOutRunsInput: document.getElementById('run-out-runs-input'),
                fullScorecardModal: document.getElementById('full-scorecard-modal'),
                fullScorecardContent: document.getElementById('full-scorecard-content'),
                closeFullScorecardBtn: document.getElementById('close-full-scorecard-btn'),
            },

            init() {
                this.generatePlayerInputs();
                this.addEventListeners();
                this.resetState();
            },

            generatePlayerInputs() {
                for (let i = 0; i < 11; i++) {
                    this.elements.teamAPlayers.innerHTML += `<input type="text" class="setup-input" placeholder="Player ${i + 1}" value="Player A${i+1}">`;
                    this.elements.teamBPlayers.innerHTML += `<input type="text" class="setup-input" placeholder="Player ${i + 1}" value="Player B${i+1}">`;
                }
            },

            resetState() {
                this.state = {
                    teamA: { name: '', players: [] },
                    teamB: { name: '', players: [] },
                    totalOvers: 20,
                    innings: 1,
                    battingTeam: null,
                    bowlingTeam: null,
                    score: 0,
                    wickets: 0,
                    overs: 0,
                    balls: 0,
                    thisOver: [],
                    thisOverRuns: 0,
                    oversHistory: [],
                    fallOfWickets: [],
                    onStrikeBatsman: null,
                    nonStrikeBatsman: null,
                    currentBowler: null,
                    isMatchOver: false,
                    target: null,
                    matchResult: '',
                    innings1Data: null,
                    isNoBallMode: false,
                };
                this.history = [];
            },
            
            saveState() {
                this.history.push(JSON.parse(JSON.stringify(this.state)));
            },

            undo() {
                if (this.state.isNoBallMode) {
                    this.state.isNoBallMode = false;
                    this.elements.noballBtn.classList.remove('bg-pink-500', 'animate-pulse');
                    this.elements.noballBtn.textContent = 'No Ball';
                    return;
                }
                if (this.history.length > 1) {
                    this.history.pop();
                    this.state = this.history[this.history.length - 1];
                    this.render();
                } else {
                    alert('No more actions to undo.');
                }
            },

            addEventListeners() {
                this.elements.startMatchBtn.addEventListener('click', () => this.startMatch());
                this.elements.newMatchBtn.addEventListener('click', () => window.location.reload());
                this.elements.undoBtn.addEventListener('click', () => this.undo());
                this.elements.fullScorecardBtn.addEventListener('click', () => this.openFullScorecard());
                this.elements.closeFullScorecardBtn.addEventListener('click', () => this.closeModal(this.elements.fullScorecardModal));
                
                this.elements.runBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const runs = parseInt(btn.dataset.run);
                        if (this.state.isNoBallMode) {
                            this.addDelivery({ runs: runs, isExtra: true, extraType: 'Nb', isNoBall: true });
                            this.state.isNoBallMode = false;
                            this.elements.noballBtn.classList.remove('bg-pink-500', 'animate-pulse');
                            this.elements.noballBtn.textContent = 'No Ball';
                        } else {
                            this.addDelivery({ runs: runs });
                        }
                    });
                });
                
                this.elements.wideBtn.addEventListener('click', () => {
                     if (this.state.isNoBallMode) return;
                     this.addDelivery({ runs: 0, isExtra: true, extraType: 'Wd' });
                });

                this.elements.noballBtn.addEventListener('click', () => {
                    this.state.isNoBallMode = true;
                    this.elements.noballBtn.classList.add('bg-pink-500', 'animate-pulse');
                    this.elements.noballBtn.textContent = 'Enter Runs...';
                });

                this.elements.wicketBtn.addEventListener('click', () => {
                     if (this.state.isNoBallMode) return;
                     this.openWicketModal()
                });

                this.elements.confirmPlayersBtn.addEventListener('click', () => this.confirmPlayers());
                this.elements.confirmWicketBtn.addEventListener('click', () => this.confirmWicket());
                this.elements.dismissalTypeSelect.addEventListener('change', (e) => this.handleDismissalTypeChange(e.target.value));
            },

            startMatch() {
                this.resetState();
                this.state.totalOvers = parseInt(this.elements.totalOversInput.value, 10) || 20;
                this.state.teamA.name = this.elements.teamAName.value.trim() || 'Team A';
                this.state.teamB.name = this.elements.teamBName.value.trim() || 'Team B';
                const createPlayer = (prefix, i) => ({ id: `${prefix}${i}`, name: `Player ${prefix}${i+1}`, runs: 0, balls: 0, fours: 0, sixes: 0, status: 'Did not bat', ballsBowled: 0, maidens: 0, runsConceded: 0, wickets: 0 });
                this.state.teamA.players = Array.from(this.elements.teamAPlayers.querySelectorAll('input')).map((input, i) => ({ ...createPlayer('A', i), name: input.value.trim() || `Player A${i+1}` }));
                this.state.teamB.players = Array.from(this.elements.teamBPlayers.querySelectorAll('input')).map((input, i) => ({ ...createPlayer('B', i), name: input.value.trim() || `Player B${i+1}` }));
                this.state.battingTeam = this.state.teamA;
                this.state.bowlingTeam = this.state.teamB;
                this.elements.setupScreen.classList.add('hidden');
                this.elements.scorecardScreen.classList.remove('hidden');
                this.saveState();
                this.openPlayerSelectionModal("Select Opening Players");
            },
            
            openModal(modal) {
                this.elements.modalBackdrop.classList.remove('hidden');
                modal.classList.remove('hidden');
            },

            closeModal(modal) {
                this.elements.modalBackdrop.classList.add('hidden');
                modal.classList.add('hidden');
            },

            openPlayerSelectionModal(title) {
                this.elements.modalTitle.textContent = title;
                const populateSelect = (select, players, exclude = []) => {
                    select.innerHTML = '';
                    players.forEach(p => {
                        if (!exclude.includes(p.id) && p.status !== 'Out' && !p.status.toLowerCase().includes('bowled') && !p.status.toLowerCase().includes('caught')) {
                            select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        }
                    });
                };
                populateSelect(this.elements.onStrikeSelect, this.state.battingTeam.players);
                populateSelect(this.elements.nonStrikerSelect, this.state.battingTeam.players, [this.elements.onStrikeSelect.value]);
                populateSelect(this.elements.bowlerSelect, this.state.bowlingTeam.players, [this.state.currentBowler]);
                this.elements.onStrikeSelect.onchange = () => {
                    populateSelect(this.elements.nonStrikerSelect, this.state.battingTeam.players, [this.elements.onStrikeSelect.value]);
                };
                this.openModal(this.elements.playerSelectionModal);
            },

            confirmPlayers() {
                this.state.onStrikeBatsman = this.elements.onStrikeSelect.value;
                this.state.nonStrikeBatsman = this.elements.nonStrikerSelect.value;
                this.state.currentBowler = this.elements.bowlerSelect.value;
                if (this.findPlayer(this.state.onStrikeBatsman).status === 'Did not bat') this.findPlayer(this.state.onStrikeBatsman).status = 'Not Out';
                if (this.findPlayer(this.state.nonStrikeBatsman).status === 'Did not bat') this.findPlayer(this.state.nonStrikeBatsman).status = 'Not Out';
                this.closeModal(this.elements.playerSelectionModal);
                this.saveState();
                this.render();
            },
            
            handleDismissalTypeChange(type) {
                if (type === 'Caught' || type === 'Stumped' || type === 'Run Out') {
                    this.elements.fielderContainer.classList.remove('hidden');
                    this.elements.fielderLabel.textContent = (type === 'Run Out' || type === 'Caught') ? 'Fielder:' : 'Keeper:';
                    this.elements.fielderSelect.innerHTML = this.state.bowlingTeam.players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                } else {
                    this.elements.fielderContainer.classList.add('hidden');
                }
                if (type === 'Run Out') {
                    this.elements.runOutRunsContainer.classList.remove('hidden');
                } else {
                    this.elements.runOutRunsContainer.classList.add('hidden');
                }
            },
            
            openWicketModal() {
                this.elements.playerOutSelect.innerHTML = `<option value="${this.state.onStrikeBatsman}">${this.findPlayer(this.state.onStrikeBatsman).name}</option><option value="${this.state.nonStrikeBatsman}">${this.findPlayer(this.state.nonStrikeBatsman).name}</option>`;
                const nextBatsmen = this.state.battingTeam.players.filter(p => p.status === 'Did not bat');
                this.elements.newBatsmanSelect.innerHTML = nextBatsmen.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                if (nextBatsmen.length === 0 || this.state.wickets >= 10) {
                    this.elements.newBatsmanContainer.classList.add('hidden');
                } else {
                    this.elements.newBatsmanContainer.classList.remove('hidden');
                }
                this.handleDismissalTypeChange(this.elements.dismissalTypeSelect.value);
                this.openModal(this.elements.wicketModal);
            },

            confirmWicket() {
                const playerOutId = this.elements.playerOutSelect.value;
                const dismissalType = this.elements.dismissalTypeSelect.value;
                const fielderId = (['Caught', 'Stumped', 'Run Out'].includes(dismissalType)) ? this.elements.fielderSelect.value : null;
                const newBatsmanId = this.elements.newBatsmanSelect.value;
                let runsOnWicket = 0;
                if (dismissalType === 'Run Out') {
                    runsOnWicket = parseInt(this.elements.runOutRunsInput.value, 10) || 0;
                }
                this.closeModal(this.elements.wicketModal);
                this.addDelivery({ runs: runsOnWicket, isWicket: true, playerOutId, dismissalType, fielderId, newBatsmanId });
            },

            findPlayer(id) {
                return this.state.teamA.players.find(p => p.id === id) || this.state.teamB.players.find(p => p.id === id);
            },

            addDelivery(delivery) {
                if (this.state.isMatchOver) return;
                this.saveState();

                const bowler = this.findPlayer(this.state.currentBowler);
                const onStrike = this.findPlayer(this.state.onStrikeBatsman);

                this.state.score += delivery.runs;
                bowler.runsConceded += delivery.runs;
                if (!delivery.isExtra || delivery.isNoBall) {
                     this.state.thisOverRuns += delivery.runs;
                }
                
                if (delivery.isExtra) {
                    this.state.thisOver.push({ type: 'extra', value: delivery.extraType, runs: delivery.runs });
                    if (delivery.isNoBall) {
                        onStrike.runs += delivery.runs;
                    }
                } else {
                    this.state.balls++;
                    onStrike.balls++;
                    onStrike.runs += delivery.runs;
                    bowler.ballsBowled++;
                    if(delivery.runs === 4) onStrike.fours++;
                    if(delivery.runs === 6) onStrike.sixes++;
                    this.state.thisOver.push({ type: 'delivery', value: delivery.isWicket ? 'W' : delivery.runs });
                }
                
                if (delivery.isWicket) {
                    this.state.wickets++;
                    const playerOut = this.findPlayer(delivery.playerOutId);
                    const bowlerName = bowler.name;
                    let dismissalString = '';

                    switch(delivery.dismissalType) {
                        case 'Caught':
                            dismissalString = `c ${this.findPlayer(delivery.fielderId).name} b ${bowlerName}`;
                            bowler.wickets++;
                            break;
                        case 'Stumped':
                            dismissalString = `st ${this.findPlayer(delivery.fielderId).name} b ${bowlerName}`;
                            bowler.wickets++;
                            break;
                        case 'Run Out':
                             dismissalString = `run out (${this.findPlayer(delivery.fielderId).name})`;
                             break;
                        case 'Bowled':
                            dismissalString = `b ${bowlerName}`;
                            bowler.wickets++;
                            break;
                        case 'LBW':
                            dismissalString = `lbw b ${bowlerName}`;
                            bowler.wickets++;
                            break;
                        default:
                            dismissalString = delivery.dismissalType;
                    }
                    playerOut.status = dismissalString;
                    this.state.fallOfWickets.push(`${this.state.wickets}-${this.state.score} (${playerOut.name}, ${this.state.overs}.${this.state.balls})`);

                    if (this.state.wickets < 10 && delivery.newBatsmanId) {
                        if(delivery.playerOutId === this.state.onStrikeBatsman) {
                            this.state.onStrikeBatsman = delivery.newBatsmanId;
                        } else {
                            this.state.nonStrikeBatsman = delivery.newBatsmanId;
                        }
                        this.findPlayer(delivery.newBatsmanId).status = 'Not Out';
                    }
                }

                if (delivery.runs % 2 !== 0 && !delivery.isExtra) {
                    [this.state.onStrikeBatsman, this.state.nonStrikeBatsman] = [this.state.nonStrikeBatsman, this.state.onStrikeBatsman];
                }

                if (this.state.balls === 6) {
                    this.state.overs++;
                    this.state.balls = 0;
                    this.state.oversHistory.push({over: this.state.overs, balls: [...this.state.thisOver]});
                    if(this.state.thisOverRuns === 0 && !this.state.thisOver.some(d => d.type === 'extra')) bowler.maidens++;
                    
                    this.state.thisOver = [];
                    this.state.thisOverRuns = 0;
                    [this.state.onStrikeBatsman, this.state.nonStrikeBatsman] = [this.state.nonStrikeBatsman, this.state.onStrikeBatsman];
                    
                    if (this.state.overs < this.state.totalOvers && !this.state.isMatchOver) {
                         this.openPlayerSelectionModal("Select Next Bowler");
                    }
                }
                
                const isOversFinished = this.state.overs === this.state.totalOvers;
                const isAllOut = this.state.wickets >= 10;
                const isTargetChased = this.state.innings === 2 && this.state.target && this.state.score >= this.state.target;

                if (!this.state.isMatchOver && (isOversFinished || isAllOut || isTargetChased)) {
                    this.endInnings();
                }

                this.render();
            },
            
            endInnings() {
                if (this.state.innings === 1) {
                    const finalHistory = [...this.state.oversHistory];
                    if (this.state.thisOver.length > 0) {
                        finalHistory.push({ over: this.state.overs + 1, balls: this.state.thisOver });
                    }
                    this.state.innings1Data = JSON.parse(JSON.stringify({
                        battingTeam: this.state.battingTeam, bowlingTeam: this.state.bowlingTeam, score: this.state.score,
                        wickets: this.state.wickets, overs: this.state.overs, balls: this.state.balls,
                        oversHistory: finalHistory, fallOfWickets: this.state.fallOfWickets
                    }));

                    alert(`Innings 1 Over! ${this.state.battingTeam.name} scored ${this.state.score}/${this.state.wickets}. Target for ${this.state.bowlingTeam.name} is ${this.state.score + 1}.`);
                    this.state.innings = 2;
                    this.state.target = this.state.score + 1;
                    [this.state.battingTeam, this.state.bowlingTeam] = [this.state.bowlingTeam, this.state.battingTeam];
                    this.state.score = 0; this.state.wickets = 0; this.state.overs = 0; this.state.balls = 0;
                    this.state.thisOver = []; this.state.thisOverRuns = 0; this.state.fallOfWickets = []; this.state.oversHistory = [];
                    this.state.onStrikeBatsman = null; this.state.nonStrikeBatsman = null; this.state.currentBowler = null;
                    this.openPlayerSelectionModal("Select Opening Players for 2nd Innings");
                } else {
                    this.state.isMatchOver = true;
                    if (this.state.score >= this.state.target) {
                        this.state.matchResult = `${this.state.battingTeam.name} won by ${10 - this.state.wickets} wickets.`;
                    } else if (this.state.score === this.state.target - 1) {
                        this.state.matchResult = 'Match Tied.';
                    } else {
                        this.state.matchResult = `${this.state.bowlingTeam.name} won by ${this.state.target - 1 - this.state.score} runs.`;
                    }
                    alert(`Match Over! ${this.state.matchResult}`);
                }
            },

            openFullScorecard() {
                this.renderFullScorecard();
                this.openModal(this.elements.fullScorecardModal);
            },
            
            renderFullScorecard() {
                 this.elements.fullScorecardContent.innerHTML = this.getInningsScorecardHTML(null, null, true);
            },

            getInningsScorecardHTML(inningsData, inningsNum, isFull) {
                if (isFull) {
                    let content = '';
                    if (this.state.innings1Data) {
                         content += this.getInningsScorecardHTML(this.state.innings1Data, 1, false);
                    }
                     const currentInningsData = {
                        battingTeam: this.state.battingTeam, bowlingTeam: this.state.bowlingTeam, score: this.state.score, wickets: this.state.wickets,
                        overs: this.state.overs, balls: this.state.balls, fallOfWickets: this.state.fallOfWickets,
                        oversHistory: [...this.state.oversHistory, ...(this.state.thisOver.length > 0 ? [{over: this.state.overs + 1, balls: this.state.thisOver}] : [])],
                    };
                    content += this.getInningsScorecardHTML(currentInningsData, this.state.innings, false);
                    return content;
                }

                const { battingTeam, bowlingTeam, score, wickets, overs, balls, oversHistory, fallOfWickets } = inningsData;
                
                const battingRows = battingTeam.players.filter(p => p.status !== 'Did not bat').map(p => {
                    const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                    return `<tr class="table-body-row"><td class="table-body-cell !text-left !whitespace-normal"><span class="font-semibold">${p.name}</span><br><span class="text-xs text-slate-400">${p.status}</span></td><td class="table-body-cell font-bold">${p.runs}</td><td class="table-body-cell">${p.balls}</td><td class="table-body-cell">${p.fours}</td><td class="table-body-cell">${p.sixes}</td><td class="table-body-cell">${sr}</td></tr>`;
                }).join('');

                const bowlingRows = bowlingTeam.players.filter(p => p.ballsBowled > 0).map(p => {
                    const oversDisplay = `${Math.floor(p.ballsBowled / 6)}.${p.ballsBowled % 6}`;
                    const econ = p.ballsBowled > 0 ? ((p.runsConceded / (p.ballsBowled / 6))).toFixed(2) : '0.00';
                    return `<tr class="table-body-row"><td class="table-body-cell !text-left !whitespace-normal font-semibold">${p.name}</td><td class="table-body-cell">${oversDisplay}</td><td class="table-body-cell">${p.maidens}</td><td class="table-body-cell">${p.runsConceded}</td><td class="table-body-cell font-bold">${p.wickets}</td><td class="table-body-cell">${econ}</td></tr>`;
                }).join('');

                const fowRows = (fallOfWickets || []).map(fow => `<p class="text-slate-300">${fow}</p>`).join('');

                const oversSummaryRows = (oversHistory || []).map(o => {
                    const ballTags = o.balls.map(ball => {
                        let ballClass = '', ballValue = ball.value;
                        if(ball.type === 'extra') {
                            ballClass = 'ball-extra'; ballValue = (ball.value === 'Nb') ? `${ball.runs}Nb` : 'Wd';
                        } else {
                             switch(ball.value) {
                                case 'W': ballClass = 'ball-wicket'; break;
                                case 4: ballClass = 'ball-four'; break;
                                case 6: ballClass = 'ball-six'; break;
                                default: ballClass = 'ball-run'; break;
                            }
                        }
                        return `<div class="ball-tag !w-9 !h-9 !text-sm ${ballClass}">${ballValue}</div>`;
                    }).join('');
                    const overLabel = o.balls.length < 6 && this.state.balls > 0 && o.over > this.state.overs ? `Over ${o.over} (progress)` : `Over ${o.over}`;
                    return `<div class="flex items-center gap-4 py-2"><div class="font-bold w-32 text-slate-300">${overLabel}:</div><div class="flex items-center flex-wrap gap-2">${ballTags}</div></div>`;
                }).join('');

                return `
                    <div>
                        <h3 class="text-2xl font-bold mb-4 text-indigo-400">${battingTeam.name} - Innings ${inningsNum} (${score}/${wickets} in ${overs}.${balls} overs)</h3>
                        <div class="mb-6"><h4 class="text-lg font-semibold mb-2 text-slate-200">Batting</h4><div class="glass-panel !rounded-lg overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-900/50"><tr><th class="table-header-cell !text-left">Batsman</th><th class="table-header-cell">R</th><th class="table-header-cell">B</th><th class="table-header-cell">4s</th><th class="table-header-cell">6s</th><th class="table-header-cell">SR</th></tr></thead><tbody>${battingRows}</tbody></table></div></div>
                        <div class="mb-6"><h4 class="text-lg font-semibold mb-2 text-slate-200">Fall of Wickets</h4><div class="glass-panel !rounded-lg p-4 space-y-1 text-sm">${fowRows}</div></div>
                        <div class="mb-6"><h4 class="text-lg font-semibold mb-2 text-slate-200">Bowling</h4><div class="glass-panel !rounded-lg overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-900/50"><tr><th class="table-header-cell !text-left">Bowler</th><th class="table-header-cell">O</th><th class="table-header-cell">M</th><th class="table-header-cell">R</th><th class="table-header-cell">W</th><th class="table-header-cell">Econ</th></tr></thead><tbody>${bowlingRows}</tbody></table></div></div>
                        <div><h4 class="text-lg font-semibold mb-2 text-slate-200">Overs Summary</h4><div class="glass-panel !rounded-lg p-4 space-y-1">${oversSummaryRows}</div></div>
                    </div>
                `;
            },

            render() {
                const { battingTeam, bowlingTeam, score, wickets, overs, balls, onStrikeBatsman, currentBowler, innings, target } = this.state;
                if (!battingTeam) return;

                this.elements.matchTitle.textContent = `${battingTeam.name} vs ${bowlingTeam.name} (${this.state.totalOvers} Over Match)`;
                this.elements.scoreDisplay.textContent = `${score}/${wickets}`;
                this.elements.oversDisplay.textContent = `Overs: ${overs}.${balls}`;

                const totalBalls = overs * 6 + balls;
                this.elements.crrDisplay.textContent = totalBalls > 0 ? `CRR: ${(score / (totalBalls / 6)).toFixed(2)}` : 'CRR: 0.00';
                
                if (innings === 2 && target) {
                    this.elements.targetDisplay.textContent = `Target: ${target}`;
                    const ballsRemaining = this.state.totalOvers * 6 - totalBalls;
                    const runsNeeded = target - score;
                    this.elements.rrrDisplay.textContent = ballsRemaining > 0 && runsNeeded > 0 ? `RRR: ${(runsNeeded / (ballsRemaining / 6)).toFixed(2)}` : '';
                } else {
                    this.elements.targetDisplay.textContent = '';
                    this.elements.rrrDisplay.textContent = '';
                }

                this.elements.battingTable.innerHTML = battingTeam.players.filter(p => p.status !== 'Did not bat').map(p => {
                    const sr = p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : '0.00';
                    const isStriker = p.id === onStrikeBatsman;
                    const rowClass = isStriker ? 'striker-row' : '';
                    const nameDisplay = `${p.name} ${isStriker ? '<span class="inline-block ml-2 text-lg">üèè</span>' : ''}`;
                    return `<tr class="table-body-row ${rowClass}"><td class="table-body-cell !text-left !whitespace-normal"><span class="font-semibold">${nameDisplay}</span><br><span class="text-xs text-slate-400">${p.status}</span></td><td class="table-body-cell font-bold text-white">${p.runs}</td><td class="table-body-cell">${p.balls}</td><td class="table-body-cell">${p.fours}</td><td class="table-body-cell">${p.sixes}</td><td class="table-body-cell">${sr}</td></tr>`;
                }).join('');

                this.elements.bowlingTable.innerHTML = bowlingTeam.players.filter(p => p.ballsBowled > 0).map(p => {
                    const ballsBowled = p.ballsBowled;
                    const oversDisplay = `${Math.floor(ballsBowled / 6)}.${ballsBowled % 6}`;
                    const econ = ballsBowled > 0 ? ((p.runsConceded / (ballsBowled/6))).toFixed(2) : '0.00';
                    const isCurrentBowler = p.id === currentBowler;
                    const rowClass = isCurrentBowler ? 'bowler-row' : '';
                    const nameDisplay = `${p.name} ${isCurrentBowler ? '<span class="inline-block ml-2 text-lg">‚öæ</span>' : ''}`;
                    return `<tr class="table-body-row ${rowClass}"><td class="table-body-cell !text-left font-semibold">${nameDisplay}</td><td class="table-body-cell">${oversDisplay}</td><td class="table-body-cell">${p.maidens}</td><td class="table-body-cell">${p.runsConceded}</td><td class="table-body-cell font-bold text-white">${p.wickets}</td><td class="table-body-cell">${econ}</td></tr>`;
                }).join('');

                this.elements.fowDisplay.innerHTML = this.state.fallOfWickets.map(fow => `<p>${fow}</p>`).join('');
                
                const liveOversHistory = [...this.state.oversHistory];
                if (this.state.thisOver.length > 0) {
                    liveOversHistory.push({ over: this.state.overs + 1, balls: this.state.thisOver });
                }

                this.elements.oversSummaryDisplay.innerHTML = liveOversHistory.map(o => {
                    const ballTags = o.balls.map(ball => {
                        let ballClass = '', ballValue = ball.value;
                        if (ball.type === 'extra') {
                            ballClass = 'ball-extra';
                            ballValue = (ball.value === 'Nb') ? `${ball.runs}Nb` : 'Wd';
                        } else {
                             switch(ball.value) {
                                case 'W': ballClass = 'ball-wicket'; break;
                                case 4: ballClass = 'ball-four'; break;
                                case 6: ballClass = 'ball-six'; break;
                                default: ballClass = 'ball-run'; break;
                            }
                        }
                        return `<div class="ball-tag !w-8 !h-8 !text-xs ${ballClass}">${ballValue}</div>`;
                    }).join('');
                    const overLabel = o.over > this.state.overs ? `Over ${o.over} (progress)` : `Over ${o.over}`;
                    return `<div class="flex items-center gap-3"><div class="font-bold w-28 text-slate-400">${overLabel}:</div><div class="flex items-center flex-wrap gap-1.5">${ballTags}</div></div>`;
                }).join('');

                if(this.state.isMatchOver) {
                    this.elements.scoringControls.classList.add('hidden');
                    this.elements.matchResultDisplay.textContent = this.state.matchResult;
                } else {
                    this.elements.scoringControls.classList.remove('hidden');
                    this.elements.matchResultDisplay.textContent = '';
                }
            }
        };

        App.init();
    });
    </script>

</body>

</html>
